generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // or sqlite for local demo
  url      = env("DATABASE_URL")
}

//////////////////////
// ENUMS
//////////////////////

enum Network {
  TESTNET
  MAINNET
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum FlowNodeType {
  TRIGGER
  CONDITION
  ACTION
  AI
}

//////////////////////
// USER
//////////////////////

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String?
  walletAddress String?  @unique
  name          String?
  createdAt     DateTime @default(now())

  apis      Api[]
  flows     Flow[]
  apiKeys   ApiKey[]
}

//////////////////////
// API KEYS (Public Access)
//////////////////////

model ApiKey {
  id          String   @id @default(cuid())
  userId      String
  key         String   @unique
  name        String?
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  requests    ApiKeyRequest[]
}

model ApiKeyRequest {
  id          String   @id @default(cuid())
  apiKeyId    String
  apiId       String
  success     Boolean
  createdAt   DateTime @default(now())

  apiKey      ApiKey   @relation(fields: [apiKeyId], references: [id])
}

//////////////////////
// API (Original + Wrapped)
//////////////////////

model Api {
  id               String   @id @default(cuid())
  userId           String
  name             String
  originalUrl      String
  wrapperUrl       String   @unique
  pricePerRequest  Float
  minPrice         Float?   @default(1)
  maxPrice         Float?   @default(1000)
  network          Network
  facilitatorUrl  String
  stacksAddress    String

  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())

  user             User     @relation(fields: [userId], references: [id])
  requests         ApiRequest[]
  payments         Payment[]
  flows            Flow[]

  agentDecisions   AgentDecision[]
}


//////////////////////
// API REQUEST LOGS
//////////////////////

model ApiRequest {
  id          String   @id @default(cuid())
  apiId       String
  success     Boolean
  responseMs  Int
  createdAt   DateTime @default(now())

  api         Api @relation(fields: [apiId], references: [id])
}

//////////////////////
// PAYMENTS (x402)
//////////////////////

model Payment {
  id              String         @id @default(cuid())
  apiId           String
  amount          Float
  txHash          String         @unique
  status          PaymentStatus
  payerAddress    String?
  createdAt       DateTime       @default(now())

  api             Api @relation(fields: [apiId], references: [id])
}

//////////////////////
// FLOWS (AUTOMATION)
//////////////////////

model Flow {
  id          String   @id @default(cuid())
  apiId       String
  userId      String
  name        String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())

  api         Api      @relation(fields: [apiId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
  nodes       FlowNode[]
}

//////////////////////
// FLOW NODES (BLOCKS)
//////////////////////

model FlowNode {
  id          String       @id @default(cuid())
  flowId      String
  type        FlowNodeType
  label       String
  config      Json
  positionX  Float
  positionY  Float

  flow        Flow         @relation(fields: [flowId], references: [id])
}

//////////////////////
// AI AGENT DECISIONS
//////////////////////

model AgentDecision {
  id          String   @id @default(cuid())
  apiId       String
  reason      String
  oldPrice    Float
  newPrice    Float
  createdAt   DateTime @default(now())

  api         Api @relation(fields: [apiId], references: [id])
}
